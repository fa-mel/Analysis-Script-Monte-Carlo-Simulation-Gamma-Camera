# Analysis of Monte Carlo Simulation Data for Gamma Camera Performance Evaluation

## 1. Overview

This project provides a comprehensive Python script for the post-processing and analysis of data generated by Monte Carlo (MC) simulations of gamma cameras. It is designed to study and optimize nuclear imaging systems. The script automates the calculation of key performance metrics—namely **system sensitivity** and **spatial resolution**—from raw simulation outputs. It facilitates a systematic comparison of different system configurations (e.g., varying collimator geometries, scintillator properties) to elucidate the fundamental trade-offs in detector design. The final output includes publication-quality plots and LaTeX-formatted tables for streamlined integration into research reports and papers.

---

## 2. Scientific Background

The performance of a gamma camera, a cornerstone of nuclear medicine imaging, is governed by a delicate balance between its ability to detect photons efficiently (sensitivity) and its capacity to resolve fine spatial details (spatial resolution).

#### 2.1. Sensitivity

System sensitivity is defined as the fraction of photons emitted by a source that are detected as valid events, typically within the photopeak energy window. It is calculated by dividing the number of detected photons by the total number of emitted photons.

The uncertainty in sensitivity is derived from the Poisson statistics of the counting process. It is calculated by dividing the square root of the number of detected photons by the total number of emitted photons.

Sensitivity is primarily influenced by the **geometric efficiency of the collimator** and the **intrinsic detection efficiency of the scintillator crystal**.

#### 2.2. Spatial Resolution

Spatial resolution quantifies the ability of the system to distinguish between two adjacent point sources. The overall system resolution is a combination of several components, principally the intrinsic resolution of the detector and the resolution of the collimator. These components are typically combined in quadrature (i.e., the square root of the sum of their squares).

- **Intrinsic Resolution**: This is determined by detector properties. Key factors include the statistical fluctuation in the number of scintillation photons and the spread of this light as it travels through the crystal to the photodetectors. Thicker crystals, while increasing sensitivity, can degrade intrinsic resolution due to increased light spread.

- **Collimator Resolution**: This is dictated by the collimator's geometry (hole diameter, length) and the distance from the source. It degrades with increasing distance.

This script quantifies resolution by measuring the **Full Width at Half Maximum (FWHM)** of the Point Spread Function (PSF). The PSF is the system's response to a point source. The script fits a Gaussian function to the 1D profiles of the PSF. The FWHM is then calculated by multiplying the standard deviation (sigma) of the fit by approximately 2.355.

The uncertainty in the FWHM is propagated from the uncertainty in sigma, which is obtained from the covariance matrix of the Gaussian fit.

#### 2.3. The Sensitivity-Resolution Trade-off

A fundamental challenge in gamma camera design is the inverse relationship between sensitivity and resolution. For instance, a collimator with smaller holes or longer septa will improve spatial resolution by rejecting more obliquely incident photons, but this simultaneously reduces the number of detected photons, thus lowering sensitivity. This script is designed to quantitatively evaluate this trade-off.

#### 2.4. Figure of Merit (FoM)

To provide a single metric for evaluating the overall performance and navigating the sensitivity-resolution trade-off, a Figure of Merit (FoM) is often used. While various definitions exist, this script employs a common formulation, calculating the FoM by dividing the Sensitivity by the FWHM.

This metric helps to identify system configurations that offer the best compromise between detecting a sufficient number of photons and maintaining high image quality.

---

## 3. Script Features

- **Batch Processing**: Seamlessly analyzes a large set of simulation data files, each corresponding to a unique system configuration.

- **Sensitivity Analysis**: Calculates system sensitivity with propagated Poisson uncertainty.

- **Resolution Analysis**:
    - Performs robust Gaussian fitting on 1D PSF profiles to determine the FWHM and its standard error.
    - Differentiates between resolution limited by collimator geometry (using "true" interaction coordinates, e.g., `xslab`) and total system resolution including detector effects (using "reconstructed" coordinates, e.g., `xslabesr`).

- **Advanced Visualization**:
    - **Per-simulation plots**: Generates detailed diagnostic plots for each run, including energy spectra with window bounds, 2D PSF heatmaps, and 1D PSF projections with Gaussian fit overlays.
    - **Summary plots**: Creates comparative graphs showing trends in sensitivity and FWHM as a function of system parameters (e.g., source-collimator distance).
    - **FoM Trade-off Plot**: Produces a scatter plot of Sensitivity vs. FWHM, providing a clear visual representation of the performance trade-off and highlighting the optimal configuration based on the FoM.

- **Automated Reporting**: Generates clean, publication-ready LaTeX code for summary tables and figure environments.

---

## 4. Dependencies

The script relies on standard scientific Python libraries:

- `numpy`
- `matplotlib`
- `scipy`

Install them using `pip`:

```bash
pip install numpy matplotlib scipy
```

---

## 5. Usage Instructions

1.  **Configuration**: All user-editable parameters are located in the `1. MAIN CONFIGURATION` section of the script.

    - **`SIMULATION_FILES_TO_ANALYZE`**: This is the primary input. It is a list of Python dictionaries. Each dictionary must define a simulation run, specifying the path to the data file and the key physical parameters associated with it.

        ```python
        {'filename': 'path/to/your/data.hsb', 'collimator': 'A', 'thickness': 10, 'distance': 5}
        ```

    - **`TOTAL_EMITTED_PHOTONS`**: Set this to the total number of primary particle histories simulated.

    - **Energy Window**: If `USE_ENERGY_WINDOW` is `True`, set the `LOWER_ENERGY_BOUND` and `UPPER_ENERGY_BOUND` (in MeV) to define the photopeak.

    - **Output Flags**: Toggle flags like `SHOW_INDIVIDUAL_PLOTS` and `GENERATE_LATEX_OUTPUT` to control the script's output.

2.  **Execution**: Run the script from your terminal:

    ```bash
    python your_script_name.py
    ```

3.  **Output**: A directory named `analysis_output` will be created. It will contain:

    - PDF files for all generated plots.
    - A text file with summary tables (if enabled).
    - A `.tex` file with LaTeX code for tables and figures (if enabled).

---

## 6. Input Data File Structure

The script is designed to read binary files (e.g., `.hsb`) containing a flat array of 32-bit floating-point numbers, representing the n-tuple output from an MC simulation. The script assumes each recorded event consists of a sequence of 15 variables. The key variables used for this analysis are:

- `ntuple[:, 8]` -> **`eslab`**: The energy (in MeV) deposited in the scintillator slab. Used for energy windowing.
- `ntuple[:, 9]` -> **`xslab`**: The x-coordinate (in cm) of the initial photon interaction in the scintillator. Used to calculate collimator-limited resolution.
- `ntuple[:, 10]` -> **`yslab`**: The y-coordinate (in cm) of the initial photon interaction.
- `ntuple[:, 13]` -> **`xslabesr`**: The energy-weighted reconstructed x-coordinate, which includes the effects of scintillation light spread (ESR: Estimated Scintillation Resolution). Used to calculate total system resolution.
- `ntuple[:, 14]` -> **`yslabesr`**: The energy-weighted reconstructed y-coordinate.

If your simulation output has a different structure, you will need to adjust the column indices in the `analyze_simulation_file` function accordingly.
